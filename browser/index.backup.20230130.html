<!DOCTYPE html>
<html lang="en">
<head>
<title>Zulip Example</title>
<META charset="UTF-8">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="-1">
  
<!-- 파일업로드  -->
<!-- https://7942yongdae.tistory.com/186 -->
<script src="./dist/zulip.cherry.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="./dist/css/markdown.css">
<script type="text/javascript"> 
    let cZulip
    // window onload 시에 CZulip 객체 생성
    window.onload = function() {
      cZulip = new cw.CZulip("zulip@cherrycorp.io",
      "YFeqVpDmkco4tXRtdnJezpObp3XZ9fJT",
      "https://ai.e4net.net");
    }

    const parser = new DOMParser();
    // show protected images
    function fetchWithAuthentication(url, authToken) {
      const headers = new Headers();
      headers.set('Authorization', `Basic ${authToken}`);
      return fetch(url, { headers });
    }

    async function displayProtectedImage(
      imageId, imageUrl, authToken
    ) {
      // Fetch the image.
      const response = await fetchWithAuthentication(
        imageUrl, authToken
      );
    
      // Create an object URL from the data.
      const blob = await response.blob();
      const objectUrl = URL.createObjectURL(blob);
      console.log(objectUrl);
    
      // Update the source of the image.
      const imageElement = document.getElementById(imageId);
      imageElement.src = objectUrl;
    }   

    async function displayProtectedImage2(
      doc,i, authToken ) {
      // Fetch the image.
      const response = await fetchWithAuthentication(
        doc.images[i].src, authToken
      );
    
      // Create an object URL from the data.
      const blob = await response.blob();
      const objectUrl = URL.createObjectURL(blob);      
      console.log(objectUrl);
      doc.images[i].src = objectUrl;
    
      return objectUrl;
    }        

    async function displayProtectedImage2(
      img, authToken ) {
      // Fetch the image.
      const response = await fetchWithAuthentication(
        img.src, authToken
      );    
      // Create an object URL from the data.
      const blob = await response.blob();
      const objectUrl = URL.createObjectURL(blob);      
      console.log(objectUrl);
      img.src = objectUrl;    
      return img;
    } 

  function get_stream_data() {
    const stream = cZulip.getStreams();
    stream.then( (data) => {
      const j = JSON.stringify(data,null,2)
      streambox.value = j;
    });
  } 

  // Zulip 객체 바로 사용하기
  function get_stream_data_from_zulip() {
    const z = cZulip.getZulip();
    z.then((zulip) => {
       zulip.streams.subscriptions.retrieve().then((data) =>{
        const j = JSON.stringify(data,null,2)
        streambox.value = j;  
      });
    });
  }
  // Zulip 메시지만 가져오기
  async function get_messages_from_zulip() {
    const readParams = {
      anchor: "newest",
      num_before: 100,
      num_after: 0,
    };

    const z = cZulip.getZulip();
    z.then((zulip) => {
      zulip.messages.retrieve(readParams).then((data) =>{        
        if(data["result"] == "success") { 
          let txt = "";
          data["messages"].forEach((item,index,arr)=>{
            msg = item["content"];
            user = item["sender_full_name"];
            channel = item["display_recipient"];                        
            txt = txt + `[${channel}]:[${user}]:${msg}<br>\r\n`;            
          });          
          const doc = parser.parseFromString(txt,'text/html');
          const base = doc.createElement('base');
          // base url 바꾸기
          // 기본은 이 페이지를 불러오는 서버의 URL이 있는데 이를 zulip서버의 url로 바꿔 준다.
          base.href = "https://ai.e4net.net";
          doc.body.appendChild(base); 
          //console.log("=========start============");
          //console.log(doc.body.innerHTML);
          //console.log("=========end============");
          rendered.innerHTML = doc.body.innerHTML;            
        }
      });
    });
  }

  function messageHandler(event) {
    const j = JSON.stringify(event,null,2)
    streambox.value += j + "\n"; 
  }
  // 실시간 메시지
  function get_message_realtime() {
    streambox.value=''
    cZulip.callOnEachMessage(messageHandler);
  }

  // 메시지 보내기
  //{result: 'success', msg: '', rendered: '<p>meee</p>'}
  function send_message() {

    const msg = msgbox.value;
    console.log(cZulip);
    /*
    cZulip.messageRender(msg).then((rmsg)=>{
      var v = msg;
      if(!rmsg) {
        v = msg;
      }
      else if (rmsg.result === "success") {
        v = rmsg.rendered;    
      }
      rendered.innerHTML = v;
    });
    */
    cZulip.sendMessage("단체1-공개","테스트토픽",msg)
     .then((res)=>{
       console.log(res);
       return;
      });
      return;
  }  
</script> 
</head>
<body>
  <p>Zulip Test</p>
  <textarea id="streambox" type="text" readonly style="width:800px;height:200px;font-size:14px;"></textarea><br/>
  <input type="button" value="스트림 가져오기" onclick="get_stream_data()">  
  <input type="button" value="메시지 가져오기" onclick="get_messages_from_zulip()">  
  <input type="button" value="데이터 가져오기(Zulip)" onclick="get_stream_data_from_zulip();">  
  <input type="button" value="실시간대화" onclick="get_message_realtime();">  
  <input type="button" value="지우기" onclick="{streambox.value=''}">  
  <div class="rendered_markdown">
    <div id = "rendered"></div>  
  </div>
  <textarea id="msgbox" type="text" style="width:800px;height:100px;font-size:14px;"></textarea><br/>
  <input type="button" value="메시지 보내기" onclick="send_message();">    
  <img id="aaa" src=https://ai.e4net.net/user_uploads/8/42/ZZ7O_ydUyjutzSR87Nh4hJGi/hau2.png>
  <br/>
  <!-- 여기서 부터 파일 업로드 -->
  <button id="btn-file-upload">파일 업로드</button>
  <input
    type="file"
    id="upload-file"
    style="display: none"
    accept="image/*"
  />
  <script>
    const inputFileUpload = document.querySelector("#upload-file");
    const zulip_server = "https://ai.e4net.net";
    const fileupload = (event) => {
      const formData = new FormData();
      formData.append("filename", event.target.files[0]);
      <!-- "Access-Control-Allow-Origin": "*", -->
      axios({
        headers: {
          "Content-Type": "multipart/form-data",
          // 추후 이부분은 서버에서 값을 채워주는 걸로 
          // "enVsaXBAY2hlcnJ5Y29ycC5pbzpZRmVxVnBEbWtjbzR0WFJ0ZG5KZXpwT2JwM1haOWZKVA==" = base64({email:apiKey})
          "Authorization":"Basic enVsaXBAY2hlcnJ5Y29ycC5pbzpZRmVxVnBEbWtjbzR0WFJ0ZG5KZXpwT2JwM1haOWZKVA==",
        },
        url: zulip_server + "/api/v1/user_uploads", // 파일 업로드 요청 URL
        method: "POST",
        data: formData,
      }).then((response) => {
        inputFileUpload.value = "";  
        // 화면에 결과 보여 주기
        rendered.innerHTML = JSON.stringify(response,null,2);

        try {
          if (response["data"]["result"] =="success") {
            f_uri = response["data"]["uri"];
            file_name = f_uri.substr(f_uri.lastIndexOf('/') + 1);
          // [hau2.png](/user_uploads/8/26/LuOw0cbnp7IBHcgOr9bB5-7I/hau2.png) 
            msgbox.value += "["+file_name+"](" + zulip_server + "/" +f_uri + ")";
          }
        } catch(err) {
          console.error(err);
        }
      });
    };

    inputFileUpload.addEventListener("change", fileupload);

    document
      .querySelector("#btn-file-upload")
      .addEventListener("click", () => {
        inputFileUpload.click();
      });

      const imageId = 'aaa';
      imageUrl = imageId.value;
      imageUrl = zulip_server + '/user_uploads/8/42/ZZ7O_ydUyjutzSR87Nh4hJGi/hau2.png';
      const authToken = 'enVsaXBAY2hlcnJ5Y29ycC5pbzpZRmVxVnBEbWtjbzR0WFJ0ZG5KZXpwT2JwM1haOWZKVA==';
      displayProtectedImage(imageId, imageUrl, authToken);    
  
  </script>  
  <!-- 여기서 부터 파일 업로드 끝-->
</body>
</html>
<!-- https://showdownjs.com/docs/quickstart/ -->